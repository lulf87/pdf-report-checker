# 报告核对工具 - 需求规格说明书 (SRS) v3.0

> **版本**: 3.0
> **日期**: 2026年2月13日
> **状态**: 整理重构版

---

## 目录

1. [范围与目标](#1-范围与目标)
2. [术语与约定](#2-术语与约定)
3. [核对内容清单](#3-核对内容清单) ⭐ 核心章节
4. [文档结构与定位](#4-文档结构与定位)
5. [核对规则详解](#5-核对规则详解)
6. [OCR与字段比对](#6-ocr与字段比对)
7. [错误分级与输出](#7-错误分级与输出)
8. [API规格](#8-api规格)
9. [部署与配置](#9-部署与配置)

---

## 1. 范围与目标

### 1.1 目标

本工具用于核对固定格式的检验报告，自动检测字段一致性、照片覆盖性和标签准确性，并输出可视化核对结果。

### 1.2 输入规格

| 项目 | 规格 |
|-----|------|
| 主要输入 | `.pdf` 格式检验报告（推荐，解析更稳定） |
| 次要输入 | `.docx` 格式（自动转换为 PDF 后处理） |
| 文件大小限制 | 不超过 50MB |

### 1.3 输出规格

| 输出类型 | 描述 |
|---------|------|
| 可视化结果 | Electron 桌面应用界面展示 |
| 导出格式 | PDF 报告、Excel 表格、JSON 数据 |
| 错误分级 | ERROR(必错)、WARN(需复核)、INFO(信息) |

---

## 2. 术语与约定

### 2.1 术语定义

| 术语 | 定义 |
|-----|------|
| **排版页** | Word/PDF 的实际页码，从第1页开始计数 |
| **严格一致** | 字符级完全一致（大小写、全半角、空格、标点敏感） |
| **/ 与空白等价** | 表格单元格空白视为 `/` |
| **非空字段联合键** | 同名多行时，用非空字段组合作为唯一匹配条件 |
| **Caption** | 照片/标签下方的说明文字 |
| **主体名** | Caption 去除编号、方位词、类别词后的核心名称 |

### 2.2 等价规则

以下值视为等价：
- 空字符串 `""`
- 斜杠 `"/"`
- `"见实物"`

---

## 3. 核对内容清单 ⭐

> 本章集中罗列所有核对项，便于快速查阅和确认覆盖范围。

### 3.1 核对项总览

| 编号 | 核对类别 | 核对对象 | 错误级别 |
|-----|---------|---------|---------|
| C01 | 首页与第三页一致性 | 委托方、样品名称、型号规格 | ERROR |
| C02 | 第三页扩展字段 | 型号规格、生产日期、产品编号/批号 | ERROR |
| C03 | 生产日期格式 | 表格与标签格式一致性 | ERROR |
| C04 | 样品描述表格 | 各部件字段与标签比对 | ERROR/WARN |
| C05 | 照片覆盖性 | 每个部件至少一张照片 | ERROR |
| C06 | 中文标签覆盖 | 单一部件至少一张中文标签 | ERROR |
| C07 | 检验项目-单项结论 | 结论与检验结果逻辑一致性 | ERROR |
| C08 | 检验项目-非空字段 | 检验结果/单项结论/备注非空 | ERROR |
| C09 | 检验项目-序号连续性 | 序号连续无跳号 | ERROR |
| C10 | 检验项目-续表标记 | 跨页续表正确标记 | ERROR |
| C11 | 页码连续性 | 页码Y连续递增，末页Y=XXX | ERROR |

---

### 3.2 C01: 首页与第三页一致性核对

**核对位置**: 首页 vs 第三页（页眉包含"检验报告首页"）

**核对字段**:

| 序号 | 字段名 | 核对规则 |
|-----|-------|---------|
| 1 | `委 托 方` | 首页值与第三页值严格一致 |
| 2 | `样品名称` | 首页值与第三页值严格一致 |
| 3 | `型号规格` | 首页值与第三页值严格一致 |

**判定标准**:
- ✅ 三个字段全部严格一致 → 通过
- ❌ 任意字段不一致 → ERROR

---

### 3.3 C02: 第三页扩展字段核对

**核对位置**: 第三页表格 vs 照片页中文标签

**核对字段**:

| 序号 | 表格字段名 | 标签字段名（映射） |
|-----|-----------|------------------|
| 1 | `型号规格` | `型号` / `规格` / `规格型号` |
| 2 | `生产日期` | `MFG` / `MFD` / `生产日期` |
| 3 | `产品编号/批号` | `批号` / `LOT` / `序列号` / `SN` |

**核对规则（按优先级）**:

**规则1: "见样品描述栏"一致性校验**

| 条件 | 判定 | 错误级别 |
|-----|------|---------|
| 三个字段值**全部**是 `见"样品描述"栏` | ✅ 通过 | - |
| 三个字段值**全部不是** `见"样品描述"栏` | → 进入规则2 | - |
| **部分是** `见"样品描述"栏`（如：1个或2个是） | ❌ 不一致 | ERROR |

**示例**:

| 型号规格 | 生产日期 | 产品编号/批号 | 判定 |
|---------|---------|--------------|------|
| 见"样品描述"栏 | 见"样品描述"栏 | 见"样品描述"栏 | ✅ 通过 |
| ABC-123 | 2026-01-08 | LOT001 | → 进入规则2 |
| 见"样品描述"栏 | 2026-01-08 | LOT001 | ❌ ERROR（不一致）|
| ABC-123 | 见"样品描述"栏 | 见"样品描述"栏 | ❌ ERROR（不一致）|

**规则2: 标签字段比对**

**触发条件**: 三个字段值**全部不是** `见"样品描述"栏` 且 包含数字和字母组合

**判定标准**:
- ✅ 表格值与标签OCR值一致 → 通过
- ❌ 表格值与标签OCR值不一致 → ERROR

---

### 3.4 C03: 生产日期格式一致性核对

**核对位置**: 第三页表格 vs 照片页中文标签

**触发条件**: `生产日期` 字段值 ≠ `见"样品描述"栏`

**核对规则**:
- 比较格式模式（如 `YYYY.MM.DD` vs `YYYY/MM/DD`）
- 不比较日期值本身
- 以标签格式为准

**示例**:

| 表格中的生产日期 | 标签上的生产日期 | 判定 |
|----------------|----------------|------|
| 2026.01.08 | 2026/01/08 | ❌ 表格错误（格式不一致）|
| 2026-01-08 | 2026-01-08 | ✅ 正确 |

---

### 3.5 C04: 样品描述表格核对

**核对位置**: 第四页起的"样品描述"表格

**核对字段**:

| 序号 | 标准列名 | 可识别的同义词 |
|-----|---------|--------------|
| 1 | `部件名称` | 部件名称、产品名称、名称 |
| 2 | `规格型号` | 规格型号、型号规格、型号、规格 |
| 3 | `序列号批号` | 序列号批号、批号、序列号、SN、LOT |
| 4 | `生产日期` | 生产日期、MFG、MFD |
| 5 | `失效日期` | 失效日期、有效期至、EXP |

**忽略列**: `序号`、`备注`

**核对规则**:
- 表格值与对应中文标签OCR值比对
- `/` 或空白视为无值，与标签无该字段等价

---

### 3.6 C05: 照片覆盖性核对

**核对对象**: 样品描述表格中的每个部件

**核对规则**:

| 条件 | 要求 | 错误级别 |
|-----|------|---------|
| 普通部件 | 至少有一张照片覆盖 | ERROR |
| "本次检测未使用"部件 | 无照片不报错 | - |

**覆盖判定**: 主体名与部件名称匹配（支持精确/部分匹配）

---

### 3.7 C06: 中文标签覆盖核对

**核对对象**: 样品描述表格中的每个部件

**核对规则**:

| 条件 | 要求 | 错误级别 |
|-----|------|---------|
| 单一部件 | 至少有一张中文标签 | ERROR |
| 同名多行部件 | 多张标签，按"非空字段联合键"分别匹配 | ERROR |
| "本次检测未使用"部件 | 无标签不报错 | - |

**中文标签判定**: 说明文字包含 `中文标签` / `中文标签样张` / `标签样张` 等

---

### 3.8 C07: 检验项目-单项结论核对

**核对位置**: 检验项目表格（表头包含：序号、检验项目、标准条款、标准要求、检验结果、单项结论、备注）

**核对逻辑**:

| 优先级 | 条件 | 期望单项结论 |
|-------|------|------------|
| 1 | 任意标准要求的检验结果 = `"不符合要求"` | `不符合` |
| 2 | 所有标准要求的检验结果 = `"——"` 或空白 | `/` |
| 3 | 任意标准要求的检验结果 = `"符合要求"` 或非空文本/数字 | `符合` |

**判定标准**:
- ✅ 实际单项结论 = 期望单项结论 → 通过
- ❌ 实际单项结论 ≠ 期望单项结论 → ERROR

**示例**:

| 标准要求1 | 标准要求2 | 期望结论 |
|---------|---------|---------|
| 符合要求 | —— | 符合 |
| 符合要求 | 不符合要求 | 不符合 |
| —— | —— | / |
| 100 | —— | 符合 |

---

### 3.9 C08: 检验项目-非空字段核对

**核对对象**: 检验项目表格

**必填字段**:

| 序号 | 字段名 | 非空要求 |
|-----|-------|---------|
| 1 | `检验结果` | 必填，不得为空 |
| 2 | `单项结论` | 必填，不得为空 |
| 3 | `备注` | 必填，不得为空 |

**合并单元格处理**:
- 以合并区域首行值作为该区域的值
- 合并区域首行为空 → 整个区域视为空值 → 逐行报错

---

### 3.10 C09: 检验项目-序号连续性核对

**核对对象**: 检验项目表格的序号列

**核对规则**:

| 校验项 | 规则 | 错误级别 |
|-------|------|---------|
| 序号连续性 | 从1开始连续递增，无跳号、无重复 | ERROR |
| 序号非空 | 序号列不得出现空白 | ERROR |

**错误示例**:
- ❌ 序号从1跳到3，缺少2
- ❌ 序号列出现空白单元格

---

### 3.11 C10: 检验项目-续表标记核对

**核对对象**: 跨页的检验项目表格

**核对规则**:

| 校验项 | 规则 | 错误级别 |
|-------|------|---------|
| 续表标记 | 同一序号跨页时，新页第一行的序号前必须加"续"字 | ERROR |
| 续字位置 | "续"字只能出现在本页第一行的序号中 | ERROR |

**正确示例**:
```
第2页末尾: 5 | 项目X | ...（未完成）
第3页第一行: 续5 | 项目X | ...（同一项目续上）
第3页第二行: 6 | 项目Y | ...
```

**错误示例**:
```
❌ 第3页第一行: 序号 5 未完成  ← 应标记为"续5"
❌ 第3页第二行: 续5  ← "续"字应在第一行
```

---

### 3.12 C11: 页码连续性核对

**核对对象**: 从第三页开始，每页右上角的页码文字（格式：`共XXX页 第Y页`）

**核对规则**:

| 校验项 | 规则 | 错误级别 |
|-------|------|---------|
| Y连续性 | Y应从1开始连续递增，无跳号、无重复 | ERROR |
| 末页Y等于XXX | 最后一页的Y值必须等于XXX | ERROR |
| XXX一致性 | 所有页的XXX值必须相同 | ERROR |

**正确示例**:
```
第3页: 共5页 第1页
第4页: 共5页 第2页
第5页: 共5页 第3页
第6页: 共5页 第4页
第7页: 共5页 第5页  ← 末页Y=5=XXX ✅
```

---

## 4. 文档结构与定位

### 4.1 页眉锚点规则

| 页面类型 | 页眉匹配规则 |
|---------|-------------|
| 第三页 | 包含 `"检验报告首页"` |
| 样品描述页 | 页面文本包含 `"样品描述"` |
| 照片页 | 包含 `"检验报告照片页"` |

### 4.2 首页三字段取值

**字段名**: `委 托 方`、`样品名称`、`型号规格`

**取值规则**:
1. 以字段名所在单元格/段落为定位
2. 取右侧相邻单元格或同一行后续文本作为值
3. 保留原始字符串，不做 trim 处理

### 4.3 检验项目表格定位

**定位规则**: 表头包含以下全部列名时判定为检验项目表格
- `序号`
- `检验项目`
- `标准条款`
- `标准要求`
- `检验结果`
- `单项结论`
- `备注`

**表格结构**:
```
检验项目表格
├── 序号 N
│   ├── 检验项目名称
│   ├── 标准条款 1
│   │   ├── 标准要求 1-1 → 检验结果 → 单项结论
│   │   └── 标准要求 1-2 → 检验结果 → 单项结论
│   └── 标准条款 2
│       └── ...
└── ...
```

---

## 5. 核对规则详解

### 5.1 部件名称匹配规则

支持三种匹配方式，按优先级依次判断：

**方式1: 精确匹配**
```
部件名称 == 主体名
```

**方式2: 部分匹配（组件→主体）**
```
部件名称 包含于 主体名
且 主体名[部件名称长度] 属于 {'及', '和', '与', '-', '（', '(', '<', '《'}
```
- ✅ `心脏脉冲电场消融仪-主机` 匹配 `心脏脉冲电场消融仪-主机及推车`

**方式3: 部分匹配（主体→组件）**
```
主体名 包含于 部件名称
且 部件名称[主体名长度] 属于 {'-', '（', '(', '<', '《'}
```
- ✅ `触摸屏连接线缆（30m）` 匹配 `心脏脉冲电场消融仪-触摸屏连接线缆（30m）`

### 5.2 Caption 主体名提取

**输入示例**:
- `№113导管动态压力检测仪`
- `№113导管动态压力检测仪 中文标签`
- `25: 心脏脉冲电场消融仪-主机 中文标签样张`

**提取步骤**:
1. 去除前缀编号: `^(?:№|No\.?|NO\.?|Number)?\s*\d+\s*`
2. 去除尾部方位词: `前侧|后侧|左侧|右侧|...`
3. 去除尾部类别词: `中文标签样张|中文标签|标签`
4. 清理所有空白字符

### 5.3 特殊处理规则

**"本次检测未使用" 部件**:
- 判定: 备注列包含 `"本次检测未使用"`
- 有照片/标签: 正常检查字段
- 无照片/标签: 不报错，标记为 `pass`
- 字段不一致: 标记为 `warning` 而非 `fail`

---

## 6. OCR与字段比对

### 6.1 总原则

- 以标签 OCR 识别值为基准
- 严格一致比对（宁可报错人工复核）
- 支持 LLM 增强识别（OCR 失败时调用）

### 6.2 字段提取正则

| 字段 | 正则表达式 |
|-----|-----------|
| 批号 | `(?:批号\|(?:LOT\|Lot\|BATCH\|Batch)\s*(?:No\.?\|#)?)[：:\s]*([^\s]+)` |
| 序列号 | `(?:序列号\|(?:SN\|S/N\|Serial)\s*(?:No\.?\|#)?)[：:\s]*([^\s]+)` |
| 生产日期 | `(?:生产日期\|(?:MFG\|MFD\|...))[：:\s]*([0-9]{4}[-./年][0-9]{1,2}[-./月][0-9]{1,2}日?)` |
| 失效日期 | `(?:失效日期\|有效期至\|(?:EXP\|Expiry)...)[：:\s]*(...)` |

### 6.3 "/" 与空白规则

| 表格值 | OCR值 | 判定 |
|-------|-------|------|
| `/` 或空白 | 无/空白 | ✅ 一致 |
| `/` 或空白 | 有值 | ❌ 表格漏填 |
| 非空 | 完全一致 | ✅ 一致 |
| 非空 | 不一致 | ❌ 不一致 |

### 6.4 LLM 增强规则

**触发条件**:
- OCR 置信度低于阈值
- 字段提取失败
- 手动启用 `enable_llm=true`

**配置项**:
```
ENABLE_LLM_COMPARISON: 是否启用 LLM 比对
LLM_COMPARISON_MODE: fallback(OCR失败时)/enhance(总是增强)/disabled
```

---

## 7. 错误分级与输出

### 7.1 分级定义

| 级别 | 定义 | 处理方式 |
|-----|------|---------|
| ERROR | 严格一致未通过、必需项缺失 | 必须修复 |
| WARN | OCR 置信度低、未使用部件字段不一致 | 需人工复核 |
| INFO | 通过项展示、统计信息 | 参考 |

### 7.2 错误代码清单

| 错误代码 | 描述 | 对应核对项 |
|---------|------|----------|
| `CONCLUSION_MISMATCH_001` | 应标为"/"但标为其他 | C07 |
| `CONCLUSION_MISMATCH_002` | 应标为"符合"但标为其他 | C07 |
| `CONCLUSION_MISMATCH_003` | 应标为"不符合"但标为其他 | C07 |
| `CONCLUSION_MISMATCH_004` | 不应标为"不符合" | C07 |
| `SERIAL_NUMBER_ERROR_001` | 序号不连续 | C09 |
| `SERIAL_NUMBER_ERROR_002` | 序号为空 | C08/C09 |
| `CONTINUATION_MARK_ERROR_001` | 缺少续表标记 | C10 |
| `CONTINUATION_MARK_ERROR_002` | 续字位置错误 | C10 |
| `THIRD_PAGE_FIELD_ERROR_001` | 第三页字段不一致 | C02 |
| `DATE_FORMAT_ERROR_001` | 生产日期格式不一致 | C03 |
| `PAGE_NUMBER_ERROR_001` | 页码Y不连续 | C11 |
| `PAGE_NUMBER_ERROR_002` | 末页Y不等于XXX | C11 |
| `PAGE_NUMBER_ERROR_003` | XXX不一致 | C11 |

---

## 8. API规格

### 8.1 端点清单

| 端点 | 方法 | 描述 |
|-----|------|------|
| `/health` | GET | 健康检查 |
| `/api/upload` | POST | 上传文件 |
| `/api/parse/{file_id}` | POST | 解析文件 |
| `/api/check/{file_id}` | POST | 执行核对 |
| `/api/result/{file_id}` | GET | 获取结果 |
| `/api/export/{file_id}` | GET | 导出报告 |

### 8.2 核对端点

```
POST /api/check/{file_id}?enable_detailed=true&enable_llm=false

Response: CheckResult
```

---

## 9. 部署与配置

### 9.1 环境要求

- Python 3.9+
- Node.js 18+
- macOS / Windows / Linux

### 9.2 配置文件

```bash
# .env
OPENROUTER_API_KEY=xxx
LLM_MODEL=google/gemini-2.0-flash-exp
ENABLE_LLM_COMPARISON=false
LLM_COMPARISON_MODE=fallback
```

### 9.3 启动方式

```bash
# 开发模式
npm run dev

# 生产模式
./启动工具.sh
```

---

## 附录 A: 数据模型

### CheckResult

```python
{
  success: bool
  file_id: str
  filename: str
  check_time: str
  total_pages: int
  home_page_fields: Dict[str, str]
  third_page_fields: Dict[str, str]
  home_third_comparison: List[FieldComparison]
  sample_description_table: TableData
  component_checks: List[ComponentCheck]
  photo_page_check: Dict
  inspection_item_check: InspectionItemCheckResult
  errors: List[ErrorItem]
  warnings: List[ErrorItem]
  info: List[ErrorItem]
}
```

### InspectionItemCheckResult

```python
{
  has_table: bool
  total_items: int
  total_clauses: int
  correct_conclusions: int
  incorrect_conclusions: int
  item_checks: List[InspectionItemCheck]
  cross_page_continuations: int
  errors: List[ErrorItem]
}
```

---

## 附录 B: 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 3.0 | 2026-02-13 | 整理重构版：新增第3章"核对内容清单"，集中罗列所有核对项；重新组织文档结构 |
| 2.2 | 2026-02-13 | 新增：第三页扩展字段核对、非空字段校验、页码连续性校验、序号连续性校验 |
| 2.1 | 2026-02-12 | 新增：检验项目表格核对（单项结论逻辑、跨页续表处理） |
| 2.0 | 2026-02-11 | 完整实现版，新增 LLM 增强、导出功能 |
| 1.0 | - | 初始需求规格 |

---

*本文档 v3.0 为整理重构版，核对内容集中在第3章呈现。*
