# 报告核对工具 - 需求规格说明书 (SRS)

> 版本: 2.0
> 日期: 2026年2月11日
> 状态: 已实现

---

## 1. 范围与目标

### 1.1 目标

本工具用于核对固定格式的检验报告，自动检测字段一致性、照片覆盖性和标签准确性，并输出可视化核对结果。

### 1.2 输入规格

- **主要输入**: `.pdf` 格式检验报告（推荐，解析更稳定）
- **次要输入**: `.docx` 格式（自动转换为 PDF 后处理）
- **文件大小限制**: 不超过 50MB

### 1.3 核对对象

| 位置 | 核对内容 |
|-----|---------|
| 首页 | 字段 `委 托 方`、`样品名称`、`型号规格` 的值 |
| 第三页 | 同三字段的值（必须与首页严格一致） |
| 第四页起 | "样品描述" 表格中各部件记录字段 |
| 照片页 | 照片覆盖性、中文标签 OCR、字段比对 |

### 1.4 输出规格

- **可视化结果**: Electron 桌面应用界面展示
- **导出格式**: PDF 报告、Excel 表格、JSON 数据
- **错误分级**: ERROR(必错)、WARN(需复核)、INFO(信息)

---

## 2. 术语与约定

### 2.1 术语定义

| 术语 | 定义 |
|-----|------|
| 排版页 | Word/PDF 的实际页码，从第1页开始计数 |
| 严格一致 | 字符级完全一致（大小写、全半角、空格、标点敏感） |
| / 与空白等价 | 表格单元格空白视为 `/` |
| 非空字段联合键 | 同名多行时，用非空字段组合作为唯一匹配条件 |
| Caption | 照片/标签下方的说明文字 |
| 主体名 | Caption 去除编号、方位词、类别词后的核心名称 |

### 2.2 等价规则

以下值视为等价：
- 空字符串 `""`
- 斜杠 `"/"`
- `"见实物"`

---

## 3. 文档结构定位

### 3.1 页眉锚点规则

页面定位采用"去除全部空白后匹配":

| 页面类型 | 页眉匹配规则 |
|---------|-------------|
| 第三页 | 包含 `"检验报告首页"` |
| 第四页起 | 页面文本包含 `"样品描述"` |
| 照片页 | 包含 `"检验报告照片页"` |

### 3.2 首页三字段

**字段名**: 固定为以下三个
- `委 托 方`
- `样品名称`
- `型号规格`

**取值规则**:
1. 以字段名所在单元格/段落为定位
2. 取右侧相邻单元格或同一行后续文本作为值
3. 保留原始字符串，不做 trim 处理

### 3.3 第三页表格

**定位规则**:
- 页眉命中 `"检验报告首页"` 的那一页
- 该页下方存在目标表格

**字段与取值**:
- 表格包含 `委托方`、`样品名称`、`型号规格` 三字段
- 处理合并单元格情况，取右侧对应行的单元格值

### 3.4 样品描述表格

**定位规则**:
- 从第四页开始出现
- 出现 `"样品描述"` 文本标记后紧跟的表格
- 可能跨页延续

**表头规则**:
- 以原始文档表头为准，不做统一映射
- 同义列名用于内部识别，对外展示仍用原文

**同义列名映射**:

| 标准列名 | 可识别的同义词 |
|---------|--------------|
| 部件名称 | 部件名称、产品名称、名称 |
| 规格型号 | 规格型号、型号规格、型号、规格 |
| 序列号批号 | 序列号批号、批号、序列号、SN、LOT |
| 生产日期 | 生产日期、MFG、MFD |
| 失效日期 | 失效日期、有效期至、EXP |

**忽略列**:
- `序号` - 不参与核对
- `备注` - 特殊处理（见 4.4 节）

---

## 4. 说明文字（Caption）解析

### 4.1 Caption 位置

- 照片/标签紧邻下方或右侧的文本
- 照片页采用 3 行表格结构：
  - 第1行: 表头 `照片和说明`
  - 第2-3行: 嵌入图片 + 说明文字
  - 多页时表头重复

### 4.2 标签判定

**中文标签判定**: 说明文字包含以下任一
- `中文标签`
- `中文标签样张`
- `中文標籤`
- `中文标签样本`
- `中文标签照片`
- `标签样张`

### 4.3 主体名提取规则

**输入示例**:
- `№113导管动态压力检测仪`
- `№113导管动态压力检测仪 前侧`
- `№113导管动态压力检测仪 中文标签`
- `25: 心脏脉冲电场消融仪-主机 中文标签样张`

**提取步骤**:
1. 去除前缀编号: `^(?:№|No\.?|NO\.?|Number)?\s*\d+\s*`
2. 去除尾部方位词: `前侧|后侧|左侧|右侧|左面|右面|正面|背面|侧面|俯视|仰视|顶部|底部|局部`
3. 去除尾部类别词: `中文标签样张|中文标签|英文标签|原文标签|标签`
4. 清理所有空白字符

**输出**: 剩余文本即为主体名

### 4.4 覆盖性要求

**照片覆盖**:
- 每个部件必须至少有一条照片说明
- 主体名与部件名称匹配（见 5.1 节）
- 同名多行只需一张照片覆盖

**中文标签覆盖**:
- 单一部件: 至少一张中文标签
- 同名多行: 多张标签，按"非空字段联合键"分别匹配

---

## 5. 部件名称匹配规则

### 5.1 匹配方式

支持三种匹配方式，按优先级依次判断：

**方式1: 精确匹配**
```
部件名称 == 主体名
```

**方式2: 部分匹配（组件→主体）**
```
部件名称 包含于 主体名
且 主体名[部件名称长度] 属于 {'及', '和', '与', '-', '（', '(', '<', '《'}
```

**示例**:
- ✅ `心脏脉冲电场消融仪-主机` 匹配 `心脏脉冲电场消融仪-主机及推车`
- ❌ `心脏脉冲电场消融仪-触摸屏` 不匹配 `心脏脉冲电场消融仪-触摸屏连接线缆`

**方式3: 部分匹配（主体→组件）**
```
主体名 包含于 部件名称
且 部件名称[主体名长度] 属于 {'-', '（', '(', '<', '《'}
```

**示例**:
- ✅ `触摸屏连接线缆（30m）` 匹配 `心脏脉冲电场消融仪-触摸屏连接线缆（30m）`
- ❌ `触摸屏` 不匹配 `心脏脉冲电场消融仪-触摸屏电源适配器`

---

## 6. OCR 字段与比对规则

### 6.1 总原则

- 以标签 OCR 识别值为基准
- 严格一致比对（宁可报错人工复核）
- 支持 LLM 增强识别（OCR 失败时调用）

### 6.2 字段提取正则

| 字段 | 正则表达式 |
|-----|-----------|
| 批号 | `(?:批号\|(?:LOT\|Lot\|BATCH\|Batch)\s*(?:No\.?\|#)?)[：:\s]*([^\s]+)` |
| 序列号 | `(?:序列号\|(?:SN\|S/N\|Serial)\s*(?:No\.?\|#)?)[：:\s]*([^\s]+)` |
| 生产日期 | `(?:生产日期\|(?:MFG\|MFD\|Manufacture(?:d)?\s*Date\|Production\s*Date\|Date))[：:\s]*([0-9]{4}[-./年][0-9]{1,2}[-./月][0-9]{1,2}日?)` |
| 失效日期 | `(?:失效日期\|有效期至\|(?:EXP\|Expiry\|Expiration)\s*(?:Date)?)[：:\s]*([0-9]{4}[-./年][0-9]{1,2}[-./月][0-9]{1,2}日?)` |
| 型号 | `型号[:\s]*([^\s]{1,50})` |
| 规格 | `规格[:\s]*([^\s]{1,50})` |

### 6.3 字段比对规则

**"/" 与空白规则**:

| 表格值 | OCR值 | 判定 |
|-------|-------|------|
| `/` 或空白 | 无/空白 | ✅ 一致 |
| `/` 或空白 | 有值 | ❌ 表格漏填 |
| 非空 | 完全一致 | ✅ 一致 |
| 非空 | 不一致 | ❌ 不一致 |

**同名多行匹配**:

对每行构建"非空字段集合"作为匹配键：
1. 匹配条件: 该行每个非空字段都必须在同一标签 OCR 中找到且值一致
2. 多候选时: 选择满足字段数最多的
3. 无匹配时: 输出不匹配及差异字段

### 6.4 LLM 增强规则

**触发条件**:
- OCR 置信度低于阈值
- 字段提取失败
- 手动启用 `enable_llm=true`

**配置项**:
```
ENABLE_LLM_COMPARISON: 是否启用 LLM 比对
LLM_COMPARISON_MODE: fallback(OCR失败时)/enhance(总是增强)/disabled
LLM_CONFIDENCE_THRESHOLD: LLM 结果置信度阈值 (默认 0.8)
```

**支持模型**:
- OpenRouter: `google/gemini-2.0-flash-exp` (默认)
- Anthropic Claude
- OpenAI GPT
- Azure OpenAI

---

## 7. 特殊处理规则

### 7.1 "本次检测未使用" 部件

**判定**: 备注列包含 `"本次检测未使用"`

**处理规则**:
- 有照片/标签: 正常检查字段
- 无照片/标签: 不报错，标记为 `pass`
- 字段不一致: 标记为 `warning` 而非 `fail`

### 7.2 额外核对（非"见样品描述栏"）

当首页/第三页三项值 **不是** `"见"样品描述"栏"` 时：

**额外核对字段**:
- 首页三项
- 第三页三项
- 第三页表格: `产品编号/批号`、`生产日期`

**出现位置要求**:
- 必须在 A: 说明文字(caption) 中出现
- 必须在 B: 中文标签 OCR 中出现
- 不要求在 C: 产品照片 OCR 中出现
- 至少出现一次即可

---

## 8. 错误分级与展示

### 8.1 分级定义

| 级别 | 定义 | 处理方式 |
|-----|------|---------|
| ERROR | 严格一致未通过、必需项缺失 | 必须修复 |
| WARN | OCR 置信度低、未使用部件字段不一致 | 需人工复核 |
| INFO | 通过项展示、统计信息 | 参考 |

### 8.2 展示要求

**必须展示**:
- 全部核对项（匹配与不匹配）
- 每条结果可追溯: 页码、表格行列、图片、OCR原文

**展示维度**:
1. 首页与第三页比对
2. 样品描述表格
3. 部件核对详情（照片覆盖、标签覆盖、字段比对）
4. 问题汇总

---

## 9. API 规格

### 9.1 端点清单

| 端点 | 方法 | 描述 | 参数 |
|-----|------|------|------|
| `/health` | GET | 健康检查 | - |
| `/api/upload` | POST | 上传文件 | `file`: PDF/DOCX |
| `/api/parse/{file_id}` | POST | 解析文件 | `file_id` |
| `/api/ocr/{file_id}/page/{page_num}` | POST | 页面 OCR | `file_id`, `page_num` |
| `/api/ocr/{file_id}/image` | POST | 图片 OCR | `file_id`, `image_path` |
| `/api/check/{file_id}` | POST | 执行核对 | `file_id`, `enable_detailed`, `enable_llm` |
| `/api/result/{file_id}` | GET | 获取结果 | `file_id` |
| `/api/export/{file_id}` | GET | 导出报告 | `file_id`, `format` |

### 9.2 核对端点参数

```
POST /api/check/{file_id}

Query Parameters:
- enable_detailed: boolean (默认 false)
    启用详细比对日志
- enable_llm: boolean (默认 false)
    启用 LLM 增强识别

Response: CheckResult
```

### 9.3 导出端点参数

```
GET /api/export/{file_id}?format={format}

Parameters:
- format: string
    可选值: "pdf", "excel", "xlsx", "json"

Response: 文件下载
```

---

## 10. 导出功能规格

### 10.1 PDF 报告

**内容结构**:
1. 封面: 文件信息、核对时间、统计概览
2. 首页与第三页比对表
3. 样品描述表格
4. 部件核对明细（每部件一页）:
   - 基本信息（名称、照片覆盖、标签覆盖）
   - 匹配的照片列表
   - 匹配的标签列表
   - 字段比对详情
   - 问题列表
5. 问题汇总

### 10.2 Excel 报告

**Sheet 结构**:
- Sheet1: 核对概览（统计、首页/第三页比对）
- Sheet2: 部件核对明细（每行一个部件）
- Sheet3: 问题汇总（分类列出所有问题）

### 10.3 JSON 导出

**数据结构**: 完整 CheckResult 对象
```json
{
  "success": true,
  "file_id": "uuid",
  "filename": "xxx.pdf",
  "check_time": "2026-01-15T10:30:00",
  "total_components": 10,
  "passed_components": 8,
  "failed_components": 2,
  "home_third_comparison": [...],
  "component_checks": [...],
  "errors": [...],
  "warnings": [...]
}
```

---

## 11. 前端界面规格

### 11.1 界面流程

```
[文件上传] → [核对准备] → [核对中] → [结果展示]
                ↓
         [LLM开关] [开始核对按钮]
```

### 11.2 结果展示页签

| 页签 | 内容 |
|-----|------|
| 首页与第三页比对 | 三字段比对表格 |
| 样品描述表格 | 完整表格数据 |
| 部件核对 | 每部件卡片（照片、标签、字段比对） |
| 问题汇总 | 分类错误警告列表 |

### 11.3 操作按钮

- **重新核对**: 重新执行核对
- **导出报告**: 下拉选择 PDF/Excel
- **上传新文件**: 返回文件上传页

---

## 12. 部署与启动

### 12.1 环境要求

- Python 3.9+
- Node.js 18+
- macOS / Windows / Linux

### 12.2 配置文件

`.env` 文件:
```bash
# LLM API Keys (至少配置一个)
OPENROUTER_API_KEY=xxx
ANTHROPIC_API_KEY=xxx
OPENAI_API_KEY=xxx

# LLM 设置
LLM_MODEL=google/gemini-2.0-flash-exp
ENABLE_LLM_COMPARISON=false
LLM_COMPARISON_MODE=fallback
```

### 12.3 启动方式

**方式1: 双击启动（Mac）**
```
启动报告核对工具.command
```

**方式2: 脚本启动**
```bash
./启动工具.sh
```

**方式3: 开发模式**
```bash
npm run dev
```

---

## 13. 附录

### 13.1 数据模型

**CheckResult**:
```python
{
  success: bool
  file_id: str
  filename: str
  check_time: str
  total_pages: int
  home_page_fields: Dict[str, str]
  third_page_fields: Dict[str, str]
  home_third_comparison: List[FieldComparison]
  sample_description_table: TableData
  component_checks: List[ComponentCheck]
  photo_page_check: Dict
  errors: List[ErrorItem]
  warnings: List[ErrorItem]
  info: List[ErrorItem]
  total_components: int
  passed_components: int
  failed_components: int
}
```

**ComponentCheck**:
```python
{
  component_name: str
  has_photo: bool
  has_chinese_label: bool
  field_comparisons: List[FieldComparison]
  issues: List[str]
  status: str  # pass/warning/fail
  # 详细模式特有:
  comparison_details: Dict
  matched_photos: List[Dict]
  matched_labels: List[Dict]
  match_reason: str
}
```

**FieldComparison**:
```python
{
  field_name: str
  table_value: str
  ocr_value: str
  is_match: bool
  issue_type: str
}
```

### 13.2 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 2.0 | 2026-02-11 | 完整实现版，新增 LLM 增强、导出功能、详细日志 |
| 1.0 | - | 初始需求规格 |

---

*本文档描述已实现的功能规格，与实际代码同步维护。*
