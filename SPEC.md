# 需求规格与校验规则（SRS）

## 范围与目标

本工具用于核对固定格式的检验报告（**优先输入为稳定来源的 `.pdf`，也支持输入 `.docx` 并转换为 `.pdf`**），并输出可视化核对结果（展示全部匹配/不匹配，支持定位跳转、OCR 详情、导出）。

### 输入与“排版页”口径（冻结）

- **当输入为 `.pdf`**：
  - **排版页 = PDF 页**（第 1/3/4 页均指 PDF 的第几页）
  - 前提：该 PDF 来源稳定、格式一致（例如固定模板系统导出），否则页码/页眉锚点可能偏移
- **当输入为 `.docx`**：
  - 必须先将 docx 渲染为 PDF（固定渲染引擎与版本），再按 PDF 页作为排版页进行定位与证据链输出

### 核对对象（必须覆盖）

- **首页**：字段 `委 托 方`、`样品名称`、`型号规格` 的值（严格一致）
- **第三页表格**：同三字段的值（严格一致，且与首页完全一致）
- **第四页起 “样品描述” 表格**：各行部件记录的字段（按原表头列，不补列、不删列；忽略“序号/备注”）
- **照片页（页眉命中“检验报告照片页”）**：
  - 每个部件必须在照片说明（caption）中覆盖
  - 每个部件必须在中文标签说明（caption 包含“中文标签/中文标签样张”）中覆盖
  - 中文标签图片需 OCR，并与表格逐字段严格一致（以标签为准）

## 术语与约定

- **排版页**：所有“第几页”均指 Word 的排版页（固定格式报告，页码不会被封面/目录干扰）。
- **严格一致**：默认采用**字符级完全一致**（大小写、全/半角、空格、标点、换行均敏感）。
- **`/` 与空白等价**：表格单元格为空白视为 `/`。
- **非空字段联合键**：同名多行时，用该行“所有非空字段”组成唯一匹配条件。

## 文档结构定位（锚点）

### 页眉锚点

> 注意：Word 页眉可能含全角/半角空格或其他空白字符。页眉判定采用“去掉全部空白再匹配”的规则。

- **第三页表格所在页**：页眉（去空白后）等于 `检验报告首页` / `检验报告首页`（以样例为准，允许这两者之一）
- **第四页开始页**：页眉（去空白后）等于 `检验报告`
- **照片页开始页**：页眉（去空白后）等于 `检验报告照片页`

### 首页三字段（字段名固定）

字段名不会变化，分别为：

- `委 托 方`
- `样品名称`
- `型号规格`

取值位置形态：

- 可能为“字段名 + 下划线 + 下划线上有值”的版式（你图1样式）
- 也可能在表格单元格中出现合并行/合并列（例如字段名所在单元格纵向合并）

**取值规则（冻结）**：

- 对每个字段，以“字段名所在单元格/段落”为定位，取其**右侧相邻单元格**或字段名后同一行的文本作为值
- 不做任何标准化/trim（除非为定位需要提取时的内部处理；最终比对仍按原始字符串完全一致）

### 第三页表格（唯一）

定位规则：

- 以页眉命中“检验报告首页/首页”的那一页为第三页目标页
- 该页下方存在且仅存在一个目标表格（样式如样例）

字段与取值规则：

- 表格中包含：`委托方`、`样品名称`、`型号规格` 三字段（字段名固定）
- 由于合并单元格的存在，字段值可能位于“字段名右侧相邻单元格”，即便字段名单元格跨行合并，仍以其右侧单元格的“对应行”取值
  - 例如：`样品名称` 字段名在第 1 列且纵向合并 1/2 行，但实际值位于第 2 列第 1 行

### 第四页起“样品描述”表格（唯一，可能跨页）

定位规则：

- 该表格只出现一次
- 只会从第四页开始出现
- 在出现一行文本 `样品描述` 后紧跟出现（样式如样例）
- 可能跨页延续

表头规则：

- 以原始文档表头为准（列数/列名不做统一映射、不补列、不删列）
- 列名可能略有变化（例如“部件名称/产品名称”“规格型号/型号规格”“序列号批号/批号/序列号”“失效日期”可选）
  - 该“同义列名映射”用于内部识别列含义，但**对外展示仍用原表头文本**

忽略列：

- 不核对 `序号`
- 不核对 `备注`

其他列：

- 参与核对（依据标签 OCR 与 caption 覆盖关系与表格逐字段一致性）

## 说明文字（caption）解析规则

### 说明文字位置

- 说明文字是照片/标签紧邻换行后的文本
- 照片页是一个 3 行表格结构：
  - 第 1 行：表头 `照片和说明`
  - 第 2、3 行：嵌入图片，图片下方为说明文字
  - 从照片页第 2 页开始，`照片和说明` 表头会在每页重复

### 标签判定

- 只要说明文字包含 `标签` 两字，则其上方图片判定为“标签图”
- 只核对 **中文标签**：说明文字包含 `中文标签` 或 `中文标签样张`

### 主体名（用于与部件名称匹配）

说明文字示例：

- `№113导管动态压力检测仪`
- `№113导管动态压力检测仪 前侧`
- `№113导管动态压力检测仪 中文标签`
- `№113导管动态压力检测仪 中文标签样张`

主体名提取规则（冻结）：

1) 去除前缀编号：形如 `№\s*\d+`（`№` 也可能为 `No.` / `NO.` / `Number` 等，见正则清单）
2) 去除尾部方位词（若出现）：如 `前侧/后侧/左侧/右侧/正面/背面/侧面/俯视/仰视/顶部/底部/局部`（可配置扩展）
3) 去除尾部类别词（若出现）：`中文标签/中文标签样张/英文标签/原文标签/标签`
4) 剩余文本（原样保留）即主体名

### 覆盖性要求

- **照片说明覆盖**：`样品描述` 表格中每个部件（按“部件名称”维度）必须至少有一条照片说明，其主体名=该部件名称
  - 若同名多行（不同批号/规格），照片说明只要出现一次即可覆盖（不要求每行一条）
- **中文标签覆盖**：
  - 若部件只有一行：至少一条中文标签说明主体名=该部件名称
  - 若部件同名多行：必须存在多张中文标签，使得 OCR 字段可以按“非空字段联合键”分别匹配到每一行

## OCR 字段与比对规则

### 总原则

- 以标签 OCR 为准
- 不做模糊匹配（宁可报错人工复核）
- 允许引入 LLM/视觉模型降低结构化错误率，但最终判定仍以“严格一致”为准

### `/` 与空白规则（冻结）

对任一字段：

- 若表格字段值为 `/` 或空白：
  - 标签 OCR 也无该字段值（未识别/为空）→ **一致**
  - 标签 OCR 识别到有值 → **问题：表格漏填**
- 若表格字段值非空：
  - 标签 OCR 必须识别到完全一致的值 → **一致**
  - 否则 → **不一致**

### 同名多行匹配（冻结）

对 `样品描述` 表格每一行，构建该行的“非空字段集合”，并用其作为匹配条件去标签 OCR 结果中找对应项：

- 匹配条件：该行每个“非空字段”都必须在同一张中文标签 OCR 结果里找到对应字段且值完全一致
- 若存在多张候选标签：
  - 优先选择“满足字段数最多/最严格”的候选（实现阶段定义确定性 tie-break）
- 若没有任何候选标签满足：
  - 输出为不匹配，并展示差异字段

## 额外要求：当字段值不是“见”样品描述“栏”

当首页/第三页的三项值**不是** `见”样品描述“栏`（完全按字面判断）时，需要额外核对：

### 额外核对字段

- 首页三项：`委 托 方`、`样品名称`、`型号规格`
- 第三页三项：同上
- 第三页表格字段：`产品编号／批号`、`生产日期`

### 出现位置要求（冻结）

上述额外字段的值：

- 必须在 **A：说明文字（caption）** 中出现
- 必须在 **B：中文标签 OCR** 中读到
- 不要求在 **C：产品照片 OCR** 中出现

出现次数：

- **至少出现一次即可**
- 业务约束：通常会出现在“首张照片”和“首个中文标签”（实现阶段可把它作为优化提示，但判定仍以“至少一次”为准）

## 错误分级与展示要求

### 分级（建议）

- **ERROR（必错）**：严格一致未通过、必需项缺失（例如某部件缺中文标签/缺照片说明/表格漏填）
- **WARN（需复核）**：OCR 置信度低/字段解析失败但可人工确认（不做模糊通过）
- **INFO（信息）**：通过项展示、统计信息

### 展示要求（冻结）

- 前端必须展示**全部项**：匹配与不匹配都要展示
- 每条结果需可追溯到：
  - 页码（排版页）
  - 表格行/列
  - 具体图片（中文标签/照片）及其说明文字
  - OCR 原文与结构化字段

## OCR 字段常用正则（初始清单，可增删）

> 说明：正则用于“从 OCR 文本中抽字段”。最终值比对仍是**完全一致**。

### 编号前缀（caption）

- `^(?:№|No\.?|NO\.?|Number)\s*\d+\s*`

### 标签类型（caption）

- 中文标签：`中文标签(?:样张)?`
- 英文标签：`英文标签`
- 原文标签：`原文标签`
- 泛标签：`标签`

### 批号（LOT / Batch）

- 中文：`批号`
- 英文：`(?:LOT|Lot|BATCH|Batch)\s*(?:No\.?|#|：|:)?`
- 提取：`(?:批号|(?:LOT|Lot|BATCH|Batch)\s*(?:No\.?|#)?)[：:\s]*([^\s]+)`

### 序列号（SN / Serial）

- 中文：`序列号`
- 英文：`(?:SN|S/N|Serial)\s*(?:No\.?|#|：|:)?`
- 提取：`(?:序列号|(?:SN|S/N|Serial)\s*(?:No\.?|#)?)[：:\s]*([^\s]+)`

### 生产日期（MFG / Date）

- 中文：`生产日期`
- 英文：`(?:MFG|MFD|Manufacture(?:d)?\s*Date|Production\s*Date|Date)`
- 提取（不做格式转换）：`(?:生产日期|(?:MFG|MFD|Manufacture(?:d)?\s*Date|Production\s*Date|Date))[：:\s]*([0-9]{4}[-./年][0-9]{1,2}[-./月][0-9]{1,2}日?)`

### 失效日期（EXP）

- 中文：`失效日期|有效期至`
- 英文：`(?:EXP|Expiry|Expiration)\s*(?:Date)?`
- 提取（不做格式转换）：`(?:失效日期|有效期至|(?:EXP|Expiry|Expiration)\s*(?:Date)?)[：:\s]*([0-9]{4}[-./年][0-9]{1,2}[-./月][0-9]{1,2}日?)`

### 型号/规格（可能在标签上出现）

- 型号：`型号`
- 规格：`规格`
- 规格型号/型号规格：`规格型号|型号规格`

> 后续扩展策略：当你提供更多真实标签 OCR 原文样例时，把“字段名同义词”与“提取正则”追加到本节，并以回归样例验证不破坏旧样例。

